
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jom Let's Go</title>
    <!-- Include Vue.js -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <!-- Include Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!--Include Bootstrap-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        #map {
            height: 400px; /* The height is 400 pixels */
            width: 100%; /* The width is the width of the web page */
        }
    </style>
</head>
<body class="m-0">
    <div id="app">
        <nav class="navbar navbar-expand-lg" style="background-color: lightblue;">
            <div class="container-fluid">
              <a class="navbar-brand" href="#">JomLet'sGo</a>
              <div class="vr me-2"></div>
              <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
              </button>
              <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                  <li class="nav-item">
                    <button type="button" class="nav-link active" @click="page='carSearch';selectedCar=null">Car Search</button>
                  </li>
                  <li class="nav-item">
                    <button type="button" class="nav-link active" @click="page='bookingDetails'">Booking Details</button>
                  </li>
              </div>
            </div>
          </nav>
        <div v-if="page == 'carSearch'">
            <div class="ps-3 pt-3">
                <button class="btn btn-primary" @click="searchForNearestCar">Search for car</button> <!--v-if="!carsList"-->
            </div>
            <hr>
            <div class="ps-3 pt-1 mb-4" v-if="carsList && !selectedCar">
                <div class="mb-3">
                    <div id="map"></div>
                    <h5 class="d-inline">Cars Found:</h5>
                    <button class="btn btn-sm btn-secondary ms-3" @click="showFilter">Filter</button>
                    <button class="btn btn-primary dropdown-toggle btn-sm float-end me-5" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Sort by
                    </button>
                    <ul class="dropdown-menu">
                        <li><button class="dropdown-item" type="button" @click="applySort('price', 'ascending')">Price ascending</button></li>
                        <li><button class="dropdown-item" type="button" @click="applySort('price', 'descending')">Price descending</button></li>
                        <li><button class="dropdown-item" type="button" @click="applySort('distance', 'ascending')">Closest</button></li>
                        <li><button class="dropdown-item" type="button" @click="applySort('distance', 'descending')">Furthest</button></li>
                    </ul>
                </div>
                <hr>
                <div v-if="filter" class="mb-3">
                    <div class="dropdown">
                        <button class="btn btn-warning dropdown-toggle btn-sm mb-3" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                          Brand
                        </button>
                        <ul class="dropdown-menu">
                            <li v-for="option in brandOptions">
                                <button type="button" class="dropdown-item" @click="applyFilter('brand',option)">{{option}} <span v-if="selectedBrand == option" class="float-end"><svg style="color:green" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check2" viewBox="0 0 16 16">
                                    <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0"/>
                                  </svg></span></button>
                            </li>
                        </ul>
                        <button class="btn btn-warning dropdown-toggle btn-sm mb-3" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Type
                        </button>
                        <ul class="dropdown-menu">
                            <li v-for="option in typeOptions">
                                <button type="button" class="dropdown-item" @click="applyFilter('type',option)">{{option}} <span v-if="selectedType == option" class="float-end"><svg style="color:green" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check2" viewBox="0 0 16 16">
                                    <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0"/>
                                  </svg></span></button>
                            </li>
                        </ul>
                        <button class="btn btn-warning dropdown-toggle btn-sm mb-3" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Available?
                        </button>
                        <ul class="dropdown-menu">
                            <li v-for="option in statusOptions">
                                <button type="button" class="dropdown-item" @click="applyFilter('status',option)">{{option}} <span v-if="selectedStatus == option" class="float-end"><svg style="color:green" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check2" viewBox="0 0 16 16">
                                    <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0"/>
                                  </svg></span></button>
                            </li>
                        </ul>
                        <button class="btn btn-secondary mb-3"  style="--bs-btn-padding-y: .2rem; --bs-btn-padding-x: .4rem; --bs-btn-font-size: .6rem;" @click="clearFilters" type="button">
                            Clear filter and sort
                        </button>
                    </div>
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Brand</th>
                            <th>Type</th>
                            <th>Available?</th>
                            <th>Price per hour</th>
                            <th>Latitude</th> <!-- Placeholder-->
                            <th>Longitude</th> <!-- Placeholder -->
                            <!-- <th>Distance</th> -->
                            <th>Select Car</th> <!-- Placeholder -->
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="car in filteredData" :key="car.Vehicle_Id">
                            <td>{{ car.Brand }}</td>
                            <td>{{ car.Type }}</td>
                            <td>{{ car.Availability }}</td>
                            <td>{{ car.Per_Hr_Price }}</td>
                            <td>{{ car.Latitude }}</td>
                            <td>{{ car.Longitude }}</td>
                            <td><button class="btn btn-success" @click="selectedCar = car">Select</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div v-else-if="noCars">
            
            </div>
            <div v-if="selectedCar && bookedCar == null" class="ps-3 pt-1">
                <h5>You have selected the following car:</h5>
                <p>Brand: {{selectedCar.Brand}}</p>
                <p>Type: {{selectedCar.Type}}</p>
                <p>Price per hour: {{selectedCar.Per_Hr_Price}}</p>
                <p>Latitude: {{selectedCar.Latitude}}</p> <!-- Placeholder-->
                <p>Longitude: {{selectedCar.Longitude}}</p> <!-- Placeholder -->
                <!-- <p>Distance: {{selectedCar.Distance}}</p> -->
                <h6 v-if="selectedCar.Availability == 'Booked'"> The car is <span class="text-danger">currently booked.</span> Would you like to receive an email when it becomes available?</h6>
                <button class="btn btn-primary mt-3" v-if="selectedCar.Availability == 'Booked'" @click="requestNotification">Notify me when the car is available</button> <!-- havent put in vue methods -->
                <button class="btn btn-primary mt-2" v-else @click="bookCar">Book car</button>
            </div>
            <div v-else-if="bookedCar != null" class="ps-3 pt-1 mb-4">
                Booking successful! You may view your booking details later under the Booking Details page.
            </div>
        </div>
        <div v-else>
            <div class="ms-3 mt-4">
                <h5>Your booking details are as follows: </h5>
                <p>Car Brand: {{bookedCar.Brand}}</p>
                <p>Car Type: {{bookedCar.Type}}</p>
                <p>Car price per hour: {{bookedCar.Per_Hr_Price}}</p>
                <p>Car Latitude: {{bookedCar.Latitude}}</p> <!-- Placeholder-->
                <p>Car Longitude: {{bookedCar.Longitude}}</p> <!-- Placeholder -->
                <p>Booking Date and Time: {{bookedCar.date}}</p> <!-- Placeholder -->
            </div>
            <div v-if="reportStarted == false">
                <h5 class="ms-3 pt-4">Have any issues with the car?</h5>
                <button class="btn btn-primary ms-3" @click="reportStarted=true">Create damage report</button>
            </div>
            <!--If car selected and booked for report-->
            <div v-if="bookedCar === null">
                <div class="ps-3 pt-3">
                    <h5>No booking found</h5>
                </div>
            </div>
            <table class="table">
                <thead>
                    <tr>
                        <th>Vehicle ID</th>
                        <th>Brand</th>
                        <th>Type</th>
                        <th>Available?</th>
                        <th>Price per hour</th>
                        <th>Latitude</th> <!-- Placeholder-->
                        <th>Longitude</th> <!-- Placeholder -->
                        <!-- <th>Distance</th> -->
                        <th>Book Car</th> <!-- Placeholder -->
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="car in filteredData" :key="car.Vehicle_Id">
                        <td>{{ car.Vehicle_Id }}</td>
                        <td>{{ car.Brand }}</td>
                        <td>{{ car.Type }}</td>
                        <td>{{ car.Availability }}</td>
                        <td>{{ car.Per_Hr_Price }}</td>
                        <td>{{ car.Latitude }}</td>
                        <td>{{ car.Longitude }}</td>
                        <td><button class="btn btn-success" @click="selectedCar = car; bookedCar = car">Select</button></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div v-else-if="noCars">
            
        </div>
        <div v-if="selectedCar" class="ps-3 pt-1 mb-4">
            <h5>You have selected the following car:</h5>
            <p>Brand: {{selectedCar.Brand}}</p>
            <p>Type: {{selectedCar.Type}}</p>
            <p>Price per hour: {{selectedCar.Per_Hr_Price}}</p>
            <p>Latitude: {{selectedCar.Latitude}}</p> <!-- Placeholder-->
            <p>Longitude: {{selectedCar.Longitude}}</p> <!-- Placeholder -->
            <!-- <p>Distance: {{selectedCar.Distance}}</p> -->
            <h6 v-if="selectedCar.Availability == 'Booked'"> The car is <span class="text-danger">currently booked.</span> Would you like to receive an email when it becomes available?</h6>
            <button class="btn btn-primary mt-3" v-if="selectedCar.Availability == 'Booked'" @click="requestNotification">Notify me when the car is available</button> <!-- havent put in vue methods -->
            <button class="btn btn-primary mt-2" v-else @click="bookCar">Book car</button>
        </div>
        <!--If car selected and booked for report-->
        <div v-if="selectedCar && bookedCar != null && reportMade == false" style="padding: 20px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
            <h2 style="margin-bottom: 15px;">Report</h2>
            <div style="margin-bottom: 15px;">
                <label for="reportDate" style="display: block; margin-bottom: 5px;">Date:</label>
                <input type="date" id="reportDate" v-model="reportDate" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px;">
            </div>
            <div v-else-if="reportMade == true" style="background-color: #f0f0f0; padding: 20px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); margin-top: 20px;">
                <h2 class="mb-4">Report</h2>
                <div>Report sent! Would you like to cancel your booking?</div>

                <button @click="cancelBooking" style="background-color: #007bff; color: #fff; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;">Cancel Booking</button>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        (g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.${c}apis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})({
          key: "AIzaSyBYUJ8kdbJv3zpxq5OGaKo4ogRmxf8RU5g",
          v: "weekly",
          // Use the 'v' parameter to indicate the version to use (weekly, beta, alpha, etc.).
          // Add other bootstrap parameters as needed, using camel case.
        });
      </script>
    <script>
        new Vue({
            el: '#app',
            data: {
                carsList: [
                    {"Vehicle_Id": 1, "Type": "Sedan", "Brand" : "Audi", "Latitude" : 1.29761, "Longitude" : 103.84940, "Availability" : "Unbooked", "Per_Hr_Price" : 6.5},
                    {"Vehicle_Id": 2, "Type": "SUV", "Brand" : "BMW", "Latitude" : 1.35446, "Longitude" : 103.95123, "Availability" : "Booked", "Per_Hr_Price" : 7}
            ],
                noCars: false,
                filter: false,
                userId: '1', // assume we know userId
                distanceSortOrder: 'ascending',
                priceSortOrder: "",
                typeOptions: [],
                statusOptions: [],
                brandOptions: [],
                selectedCar: null,
                bookedCar: null,
                reportDate: '',
                damageDescription: '',
                reportStarted: false,
                reportMade: false,
                selectedBrand: "",
                selectedType: "",
                selectedStatus: "",
                page: 'carSearch',
                map: null,
                markers: [],
                infowindow: null,
            },
            computed: {
                filteredData() {
                    let filtered = this.carsList;

                    // Apply type and status filters
                    if (this.selectedType) {
                        filtered = filtered.filter(item => item.Type === this.selectedType);
                    }
                    if (this.selectedStatus) {
                        filtered = filtered.filter(item => item.Availability === this.selectedStatus);
                    }
                    if (this.selectedBrand) {
                        filtered = filtered.filter(item => item.Brand === this.selectedBrand);
                    }

                    // Apply distance and price sorting
                    if (this.priceSortOrder === 'ascending') {
                        filtered.sort((a, b) => a.Per_Hr_Price - b.Per_Hr_Price);
                    } else {
                        filtered.sort((a, b) => b.Per_Hr_Price - a.Per_Hr_Price);
                    }

                    if (this.distanceSortOrder === 'ascending') {
                        // filtered.sort((a, b) => a.Per_Hr_Price - b.Per_Hr_Price);
                    } else {
                        // filtered.sort((a, b) => b.Per_Hr_Price - a.Per_Hr_Price);
                    }

                    return filtered;
                }
            },
            mounted(){

            },
            methods: {
                async initMarkers(){
                    const {Geocoder} = await google.maps.importLibrary("geocoding");
                    const { InfoWindow } = await google.maps.importLibrary("maps");
                    const { AdvancedMarkerElement, PinElement } = await google.maps.importLibrary("marker");
                    var geocoder = new Geocoder();
                    this.infowindow = new InfoWindow({
                        content: ""
                    })
                    for (let i=0;i<this.carsList.length;i++){
                        let car = this.carsList[i];
                        geocoder.geocode({'location' : {lat: car.Latitude, lng: car.Longitude}},  function(results, status) {
                            if (status === 'OK') {
                                car.Address = results[0].formatted_address
                                console.log(car.Address)
                            }
                        })
                        const pinStyle =  new PinElement({
                            scale: 1,
                            background: "lightblue",
                            borderColor: "blue",
                            glyphColor: "blue"
                        });
                        let marker = new AdvancedMarkerElement({
                            map: this.map,
                            title: car.Vehicle_Id.toString(),
                            position: {lat: car.Latitude, lng: car.Longitude},
                            content: pinStyle.element
                        })
                        marker.addListener("click", () => {
                            this.infowindow.setContent("<h5 class='h5'> Vehicle ID:" + car.Vehicle_Id + "</h5> <hr class='black'>" + "<div style='color:black;'> Address (may not be readable, use coordinates if necessary): " + car.Address + "\n Coordinates: " + car.Latitude + "," + car.Longitude + "</div>")
                            this.infowindow.open({
                            anchor: marker,
                            });
                        });
                    }
                },
                async initMap(userLoc) {
                // The location of Uluru
                const position = { lat: userLoc.latitude, lng: userLoc.longitude};
                // Request needed libraries.
                //@ts-ignore
                const { Map } = await google.maps.importLibrary("maps");
                const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");

                // The map, centered at User's location
                this.map = new Map(document.getElementById("map"), {
                    zoom: 11,
                    center: position,
                    mapId: 'ff540a478a073267',
                });

                // User marker
                const marker = new AdvancedMarkerElement({
                    map: this.map,
                    position: position,
                    title: "User Location",
                });
                marker.addListener("click", () => {
                    this.infowindow.setContent("<h5 class='h5'>" + "User Location" + "</h5>")
                    this.infowindow.open({
                    anchor: marker,
                    map,
                    });
                });
                },
                applySort(metric, order){
                    if (metric == "price"){
                        this.distanceSortOrder = ''
                        this.priceSortOrder = order
                    }else{
                        this.priceSortOrder = ''
                        this.distanceSortOrder = order
                    }
                },
                applyFilter(field, option){
                    if (field == "brand"){
                        this.selectedBrand = option
                    }
                    if (field == "type"){
                        this.selectedType = option
                    }
                    if (field == "status"){
                        this.selectedStatus = option
                    }
                },
                showFilter(){
                    if (this.filter){
                        this.filter = false;
                    }else{
                        this.filter= true;
                    }
                },
                // async convertCarLocationsToAddresses(){
                //     const {Geocoder} = await google.maps.importLibrary("geocoding");
                //     var geocoder = new Geocoder();
                //     for (let i=0; i<this.carsList.length;i++){
                //         let car = this.carsList[i];
                //         let location = new google.maps.LatLng(car.Latitude, car.Longitude);
                //         geocoder.geocode({'location' : location},  function(results, status) {
                //             if (status === 'OK') {
                //                 car.Address = results[0].formatted_address
                //                 console.log(car.Address)
                //             }
                //         })
                //     }
                // },
                searchForNearestCar() {
                // Get user's location using Geolocation API
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(position => {
                            var xhr = new XMLHttpRequest();
                            xhr.open("POST", "http://localhost:5100/findNearestCars");
                            xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
                            xhr.setRequestHeader('Access-Control-Allow-Origin', '*');
                            xhr.onreadystatechange = function () {
                                if (xhr.readyState === 4 && xhr.status === 200) {
                                    // this.carsList = xhr.response.data.cars;
                                    // this.extractOptions();
                                    // this.initMap(position.coords);
                                    // this.initMarkers();
                                }
                            };
                            xhr.send(JSON.stringify({
                                "lat": position.coords.latitude,
                                "long": position.coords.longitude
                            }));
                            this.initMap(position.coords);
                            // this.convertCarLocationsToAddresses();
                            this.initMarkers();
                            this.extractOptions();
                        })

                    }
                },
                extractOptions() {
                    this.typeOptions = [...new Set(this.carsList.map(car => car.Type))];
                    this.statusOptions = [...new Set(this.carsList.map(car => car.Availability))];
                    this.brandOptions = [...new Set(this.carsList.map(car => car.Brand))];
                },
                selectCar(car) {
                    this.selectedCar = car;
                },
                bookCar(){
                    var xhr = new XMLHttpRequest();
                    this.bookedCar = this.selectedCar; //TEMP
                    this.bookedCar['date'] = new Date().toLocaleString();
                    xhr.open("POST", "http://localhost:5101/car_rental");
                    xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
                    xhr.setRequestHeader('Access-Control-Allow-Origin', '*');
                    xhr.onreadystatechange = function () {
                        if (xhr.readyState === 4 && xhr.status === 200) {
                            console.log("Booking successful");
                            this.bookedCar = this.selectedCar
                            this.selectedCar = null 
                        }
                    };
                    xhr.send(JSON.stringify({
                        "user_id": this.userId,
                        "car_id": this.selectedCar.Vehicle_Id 
                    }))
                },
                clearFilters() {
                    this.selectedType = '';
                    this.selectedStatus = '';
                    this.selectedBrand = '';
                    this.priceSortOrder = 'ascending';
                    
                },
                requestNotification(){
                    var xhr = new XMLHttpRequest();
                    xhr.open("POST", "http://localhost:5004/send_notification");
                    xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
                    xhr.setRequestHeader('Access-Control-Allow-Origin', '*');
                    xhr.onreadystatechange = function () {
                        if (xhr.readyState === 4 && xhr.status === 200) {
                            console.log("Request for notification successful");
                        }
                    };
                    xhr.send(JSON.stringify({
                        "user_id": this.userId,
                        "car_id": this.selectedCar.Vehicle_Id 
                    }));
                },
                reportCar() {
                    // Validate date and damage description
                    if (!this.reportDate || !this.damageDescription) {
                        alert('Please provide both date and damage description.');
                        return;
                    }
                    // Construct report data
                    const reportData = {
                        user_id: this.userId,
                        vehicle_id: this.bookedCar.Vehicle_Id,
                        date: this.reportDate,
                        damages: [this.damageDescription]
                    };
                    // Make POST request to report car
                    axios.post('http://localhost:5102/create_report', reportData)
                        .then(response => {
                            alert("Car reported successfully");
                            console.log('Reported car data:', response.data);
                            this.reportDate = '';
                            this.damageDescription = '';
                            this.reportMade = true;
                        })
                        .catch(error => {
                            console.error('Error reporting car:', error);
                        });
                },
                //cancel booking after report is created
                cancelBooking(){
                    const report = {
                        vehicle_id: this.bookedCar.Vehicle_Id,
                    }
                    axios.post('http://localhost:5102/cancel', report)
                        .then(response => {
                            alert("Car booking cancelled");
                            console.log('Cancelled:', response.data);
                            this.bookedCar = null;
                            this.reportMade = false;
                        })
                        .catch(error => {
                            console.error('Error cancelling booking:', error);
                        });

                }
            }
        });
    </script>
</body>

</html>
