
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vue.js and Axios Example</title>
    <!-- Include Vue.js -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <!-- Include Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <div id="app">
        <h1>Book Car</h1>
        <!--Filters-->
        <div>
            <label for="price">Price:</label>
            <select id="price" v-model="priceSortOrder">
                <option value="ascending">Ascending</option>
                <option value="descending">Descending</option>
            </select>

            <label for="type">Type:</label>
            <select id="type" v-model="selectedType">
                <option v-for="type in typeOptions" :value="type">{{ type }}</option>
            </select>
            <label for="status">Status:</label>
            <select id="status" v-model="selectedStatus">
                <option v-for="status in statusOptions" :value="status">{{ status }}</option>
            </select>
            <label for="brand">Brand:</label>
            <select id="brand" v-model="selectedBrand">
                <option v-for="brand in brandOptions" :value="type">{{ brand }}</option>
            </select>

            <button @click="fetchData">Search for Car</button>
            <button @click="resetFilters">Reset Filters</button>
        </div>
        <hr>
        <table v-if="showList">
            <!--Table of cars-->
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Brand</th>
                    <th>Availability</th>
                    <th>Per_Hr_Price</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="item in filteredData" :key="item.id">
                    <td>{{ item.id }}</td>
                    <td>{{ item.Type }}</td>
                    <td>{{ item.Brand }}</td>
                    <td>{{ item.Availability }}</td>
                    <td>{{ item.Per_Hr_Price }}</td>
                    <td><button @click="selectCar(item)">Select</button></td>
                </tr>
            </tbody>
        </table>
        <!--If car selected-->
        <div v-if="selectedCar && bookedCar == null">
            <h2>Selected Car:</h2>
            <p>Type: {{ selectedCar.Type }}</p>
            <p>Type: {{ selectedCar.Brand }}</p>
            <p>Type: {{ selectedCar.Per_Hr_Price }}</p>
            <p>Status: {{ selectedCar.Availability }}</p>
            <button v-if="selectedCar.status == 'Booked'" @click="requestNotification">Send notification</button> <!-- havent put in vue methods -->
            <button v-else @click="bookCar">Book Car</button>
        </div>
        <!--If car selected and booked for report-->
        <div v-if="selectedCar && bookedCar != null && reportMade == false" style="background-color: #f0f0f0; padding: 20px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
            <h2 style="margin-bottom: 15px;">Report</h2>
            <div style="margin-bottom: 15px;">
                <label for="reportDate" style="display: block; margin-bottom: 5px;">Date:</label>
                <input type="date" id="reportDate" v-model="reportDate" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px;">
            </div>
            <div style="margin-bottom: 15px;">
                <label for="damageDescription" style="display: block; margin-bottom: 5px;">Damage Description:</label>
                <textarea id="damageDescription" v-model="damageDescription" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; resize: vertical;"></textarea>
            </div>
            <button @click="reportCar" style="background-color: #007bff; color: #fff; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Report Car</button>
        </div>
        <div v-if="reportMade == true" style="background-color: #f0f0f0; padding: 20px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); margin-top: 20px;">
            <h2 style="margin-bottom: 15px;">Report</h2>
            <div>Report sent! Would you like to cancel your booking?</div>
            
            <button @click="cancelBooking" style="background-color: #007bff; color: #fff; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;">Cancel Booking</button>
        </div>
    </div>

    <script>
        new Vue({
            el: '#app',
            data: {
                data: [],
                userId: '1', // assume we know userId
                selectedType: '',
                selectedStatus: '',
                selectedBrand: '',
                priceSortOrder: 'ascending',
                typeOptions: [],
                statusOptions: [],
                brandOptions: [],
                showList: false,
                selectedCar: null,
                bookedCar: null,
                reportDate: '',
                damageDescription: '',
                reportMade: false
            },
            computed: {
                filteredData() {
                    let filtered = this.data;

                    // Apply type and status filters
                    if (this.selectedType) {
                        filtered = filtered.filter(item => item.Type === this.selectedType);
                    }
                    if (this.selectedStatus) {
                        filtered = filtered.filter(item => item.Availability === this.selectedStatus);
                    }
                    if (this.selectedBrand) {
                        filtered = filtered.filter(item => item.Brand === this.selectedBrand);
                    }
                    // Apply distance sorting
                    if (this.priceSortOrder === 'ascending') {
                        filtered.sort((a, b) => a.Per_Hr_Price - b.Per_Hr_Price);
                    } else {
                        filtered.sort((a, b) => b.Per_Hr_Price - a.Per_Hr_Price);
                    }




                    return filtered;
                }
            },

            methods: {
                //Search for cars
                fetchData() {
                // Get user's location using Geolocation API
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(position => {
                        var xhr = new XMLHttpRequest();
                        xhr.open("POST", "http://localhost:5000/findNearestCars");
                        xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
                        xhr.setRequestHeader('Access-Control-Allow-Origin', '*');
                        xhr.onreadystatechange = function () {
                            if (xhr.readyState === 4 && xhr.status === 200) {
                                console.log("Location sent successfully");
                                // data
                                this.data = xhr.responseText.cars;
                                this.extractOptions();
                                this.showList = true; // Show the list after fetching data                                
                            }
                        };
                        console.log(position)
                        xhr.send(JSON.stringify({
                            "lat": position.coords.latitude,
                            "long": position.coords.longitude
                        }));
                    })
                }
            },
                //         // Make GET request to your API endpoint with user's location
                //         axios.post("http://localhost:5001/findNearestCars/", data, {headers: 
                //             {"Access-Control-Allow-Origin": "*",
                //             "Content-Type" : "application/json;charset=UTF-8"
                //         }
                //         })
                //             .then(response => {
                //                 this.data = response.data;
                //                 this.extractOptions();
                //                 this.showList = true; // Show the list after fetching data
                //             })
                //             .catch(error => {
                //                 console.error('There was an error!', error);
                //             });
                //     }, error => {
                //         console.error('Error getting user location:', error);
                //     });
                // } else {
                //     console.error('Geolocation is not supported by this browser.');
                // }
            // },
                extractOptions() {
                    this.typeOptions = [...new Set(this.data.map(item => item.Type))];
                    this.statusOptions = [...new Set(this.data.map(item => item.Availability))];
                    this.brandOptions = [...new Set(this.data.map(item => item.Brand))];
                },
                selectCar(car) {
                    this.selectedCar = car;
                },
                //book car
                bookCar() {
                    axios.post('https://your-microservice-endpoint.com/data', this.selectedCar)
                        .then(response => {
                            alert("Car booked");
                            this.bookedCar = selectedCar;
                            console.log('Data sent to microservice:', response.data);
                            // Optionally, you can reset selectedCar here
                        })
                        .catch(error => {
                            console.error('Error sending data to microservice:', error);
                        });
                },
                resetFilters() {
                    this.selectedType = '';
                    this.selectedStatus = '';
                    this.selectedBrand = '';
                    this.priceSortOrder = 'ascending';
                    
                },
                requestNotification(){
                    //not done yet
                },
                reportCar() {
                    // Validate date and damage description
                    if (!this.reportDate || !this.damageDescription) {
                        alert('Please provide both date and damage description.');
                        return;
                    }

                    // Construct report data
                    const reportData = {
                        user_id: this.userId,
                        vehicle_id: this.bookedCar.Vehicle_Id,
                        date: this.reportDate,
                        damages: [this.damageDescription]
                    };

                    // Make POST request to report car
                    axios.post('http://localhost:5000/report', reportData)
                        .then(response => {
                            alert("Car reported successfully");
                            console.log('Reported car data:', response.data);
      
                            this.reportDate = '';
                            this.damageDescription = '';
                            this.reportMade = true;
                        })
                        .catch(error => {
                            console.error('Error reporting car:', error);
                        });
                },
                //cancel booking after report is created
                cancelBooking(){
                    const report = {
                        vehicle_id: this.bookedCar.Vehicle_Id,
                    }
                    axios.post('http://localhost:5000/cancel', report)
                        .then(response => {
                            alert("Car booking cancelled");
                            console.log('Cancelled:', response.data);
                            this.bookedCar = null;
                            this.reportMade = false;
                        })
                        .catch(error => {
                            console.error('Error cancelling booking:', error);
                        });

                }
            }
        });
    </script>
</body>
</html>
