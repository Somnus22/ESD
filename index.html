
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vue.js and Axios Example</title>
    <!-- Include Vue.js -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <!-- Include Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!--Include Bootstrap-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body class="m-0">
    <div id="app">
        <div style="height: 10vh; background-color: lightgreen;" class="p-3">
            <h2>Car Search</h2>
        </div>
        <div class="ps-3 pt-3">
            <button class="btn btn-primary rounded-pill" @click="searchForNearestCar">Find a car now</button>
        </div>
        <hr>
        <div class="ps-3 pt-1 mb-4" v-if="carsList && !selectedCar">
            <h5>Cars Found: <button class="btn btn-sm btn-secondary ms-3" @click="showFilter">Filter</button></h5>
            <div v-if="filter">
                <div class="dropdown">
                    <button class="btn btn-warning dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                      Brand
                    </button>
                    <ul class="dropdown-menu">
                      <li><a class="dropdown-item" href="#"> Action</a></li>
                      <li><a class="dropdown-item" href="#">Another action</a></li>
                      <li><a class="dropdown-item" href="#">Something else here</a></li>
                    </ul>
                </div>
            </div>
            <table class="table">
                <thead>
                    <tr>
                        <th>Brand</th>
                        <th>Type</th>
                        <th>Available?</th>
                        <th>Price per hour</th>
                        <th>Latitude</th> <!-- Placeholder-->
                        <th>Longitude</th> <!-- Placeholder -->
                        <!-- <th>Distance</th> -->
                        <th>Book Car</th> <!-- Placeholder -->
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="car in carsList" :key="car.Vehicle_Id">
                        <td>{{ car.Brand }}</td>
                        <td>{{ car.Type }}</td>
                        <td>{{ car.Availability }}</td>
                        <td>{{ car.Per_Hr_Price }}</td>
                        <td>{{ car.Latitude }}</td>
                        <td>{{ car.Longitude }}</td>
                        <td><button class="btn btn-success" @click="selectCar(car)">Select</button></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div v-else-if="noCars">
            
        </div>
        <div v-if="selectedCar" class="ps-3 pt-1 mb-4">
            <h5>You have selected the following car:</h5>
            <p>Brand: {{selectedCar.Brand}}</p>
            <p>Type: {{selectedCar.Type}}</p>
            <p>Price per hour: {{selectedCar.Per_Hr_Price}}</p>
            <p>Latitude: {{selectedCar.Latitude}}</p> <!-- Placeholder-->
            <p>Longitude: {{selectedCar.Longitude}}</p> <!-- Placeholder -->
            <!-- <p>Distance: {{selectedCar.Distance}}</p> -->
            <h6 v-if="selectedCar.Availability == 'Booked'"> The car is <span class="text-danger">currently booked.</span> Would you like to receive an email when it becomes available?</h6>
            <button class="btn btn-primary mt-3" v-if="selectedCar.Availability == 'Booked'" @click="requestNotification">Notify me when the car is available</button> <!-- havent put in vue methods -->
            <button class="btn btn-primary mt-2" v-else @click="bookCar">Book car</button>
        </div>
        <div v-else>
            <h2>Report</h2>
            <div>
                <label for="reportDate">Date:</label>
                <input type="date" id="reportDate" v-model="reportDate">
            </div>
            <div>
                <label for="damageDescription">Damage Description:</label>
                <textarea id="damageDescription" v-model="damageDescription"></textarea>
            </div>
            <button @click="reportCar">Report Car</button>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        new Vue({
            el: '#app',
            data: {
                carsList: [{"Vehicle_Id": 1, "Type": "Sedan", "Brand" : "Audi", "Latitude" : 1.35, "Longitude" : 104.5, "Availability" : "Unbooked", "Per_Hr_Price" : 6.5}],
                noCars: false,
                filter: false,
                data: [],
                userId: '1', // assume we know userId
                distanceSortOrder: 'ascending',
                typeOptions: [],
                statusOptions: [],
                showList: false,
                selectedCar: null,
                bookedCar: null,
                reportDate: '',
                damageDescription: ''
            },
            computed: {
                filteredData() {
                    let filtered = this.data;

                    // Apply type and status filters
                    if (this.selectedType) {
                        filtered = filtered.filter(item => item.type === this.selectedType);
                    }
                    if (this.selectedStatus) {
                        filtered = filtered.filter(item => item.status === this.selectedStatus);
                    }

                    // Apply distance sorting
                    if (this.distanceSortOrder === 'ascending') {
                        filtered.sort((a, b) => a.distance - b.distance);
                    } else {
                        filtered.sort((a, b) => b.distance - a.distance);
                    }

                    return filtered;
                }
            },

            methods: {
                showFilter(){
                    if (this.filter){
                        this.filter = false;
                    }else{
                        this.filter= true;
                    }
                },
                searchForNearestCar() {
                // Get user's location using Geolocation API
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(position => {
                            var xhr = new XMLHttpRequest();
                            xhr.open("POST", "http://localhost:5100/findNearestCars");
                            xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
                            xhr.setRequestHeader('Access-Control-Allow-Origin', '*');
                            xhr.onreadystatechange = function () {
                                if (xhr.readyState === 4 && xhr.status === 200) {
                                    console.log("Location sent successfully");
                                }
                            };
                            console.log(position)
                            xhr.send(JSON.stringify({
                                "lat": position.coords.latitude,
                                "long": position.coords.longitude
                            }));
                        })
                    }
                },
                extractOptions() {
                    this.typeOptions = [...new Set(this.data.map(item => item.type))];
                    this.statusOptions = [...new Set(this.data.map(item => item.status))];
                },
                selectCar(car) {
                    this.selectedCar = car;
                },
                bookCar(){
                    var xhr = new XMLHttpRequest();
                    xhr.open("POST", "http://localhost:5101/car_rental");
                    xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
                    xhr.setRequestHeader('Access-Control-Allow-Origin', '*');
                    xhr.onreadystatechange = function () {
                        if (xhr.readyState === 4 && xhr.status === 200) {
                            console.log("Booking successful");
                        }
                    };
                    xhr.send(JSON.stringify({
                        "user_id": this.userId,
                        "car_id": this.selectedCar.Vehicle_Id 
                    }));
                },
                resetFilters() {
                    this.selectedType = '';
                    this.selectedStatus = '';
                    this.distanceSortOrder = 'ascending';
                },
                requestNotification(){
                    var xhr = new XMLHttpRequest();
                    xhr.open("POST", "http://localhost:5004/send_notification");
                    xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
                    xhr.setRequestHeader('Access-Control-Allow-Origin', '*');
                    xhr.onreadystatechange = function () {
                        if (xhr.readyState === 4 && xhr.status === 200) {
                            console.log("Request for notification successful");
                        }
                    };
                    xhr.send(JSON.stringify({
                        "user_id": this.userId,
                        "car_id": this.selectedCar.Vehicle_Id 
                    }));
                },
                reportCar() {
                    // Validate date and damage description
                    if (!this.reportDate || !this.damageDescription) {
                        alert('Please provide both date and damage description.');
                        return;
                    }

                    // Construct report data
                    const reportData = {
                        userId : this.userId,
                        car: this.bookedCar, //can change 
                        date: this.reportDate,
                        damageDescription: this.damageDescription
                    };

                    // Make POST request to report car
                    axios.post('https://your-microservice-endpoint.com/report', reportData)
                        .then(response => {
                            alert("Car reported successfully");
                            console.log('Reported car data:', response.data);
                            // Optionally, you can reset reportDate and damageDescription here
                            this.reportDate = '';
                            this.damageDescription = '';
                        })
                        .catch(error => {
                            console.error('Error reporting car:', error);
                        });
                }
            }
        });
    </script>
</body>
</html>
